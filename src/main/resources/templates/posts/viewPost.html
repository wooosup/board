<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${post.title}">ê²Œì‹œê¸€ ìƒì„¸</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
        }
        .post-container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 50px;
            margin-bottom: 50px;
        }

        .post-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #343a40;
            margin-bottom: 10px;
        }

        .post-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .post-author,
        .post-date,
        .post-views {
            font-weight: bold;
        }

        .comment-section {
            margin-top: 40px;
        }

        .comment {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .comment:last-child {
            border-bottom: none;
        }

        .comment-actions {
            float: right;
        }

        .edit-comment-form {
            display: none;
            margin-top: 15px;
        }

        .img-fluid.custom-image {
            max-width: 600px; /* ì›í•˜ëŠ” ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
            width: 100%;
            height: auto;
        }

        .like-section {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            margin-top: 10px;
            gap: 8px;
        }

        /* ì¢‹ì•„ìš” ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .like-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ë²„íŠ¼ ìì²´ */
        .like-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 0;
            font-size: 14px;
            color: #495057;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }

        /* ë²„íŠ¼ í˜¸ë²„ ì‹œ */
        .like-btn:hover {
            color: #212529;
            transform: translateY(-2px);
        }

        .like-btn {
            font-size: 2rem;
        }

        /* ë²„íŠ¼ í´ë¦­ ì‹œ */
        .like-btn:active {
            transform: translateY(0);
        }

        .like-count {
            font-size: 1rem;
            color: #495057;
            font-weight: bold;
            transition: color 0.3s ease;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="post-container">
                <!-- í”Œë˜ì‹œ ë©”ì‹œì§€ ì˜ì—­ -->

                <h2 class="post-title" th:text="${post.title}">ê²Œì‹œê¸€ ì œëª©</h2>
                <p class="post-meta">
                    ì‘ì„±ì: <span class="post-author" th:text="${post.nickname}">ì‘ì„±ì</span> Â·
                    ì‘ì„±ì¼: <span class="post-date" th:text="${post.createDateTime}">ì‘ì„±ì¼</span> Â·
                    ì¡°íšŒìˆ˜: <span class="post-views" th:text="${post.viewCount}">ì¡°íšŒìˆ˜</span>
                </p>
                <hr>
                <div th:text="${post.content}" class="mb-3">ê²Œì‹œê¸€ ë‚´ìš©</div>

                <div th:if="${!#lists.isEmpty(post.images)}">
                    <div class="row justify-content-center">
                        <div class="col-md-6 col-sm-8 mb-3" th:each="image : ${post.images}">
                            <img th:src="@{${image.imgUrl}}" alt="ì´ë¯¸ì§€" class="img-fluid rounded shadow-sm custom-image">
                        </div>
                    </div>
                </div>
                <hr>
                <div>
                    <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
                    <div class="like-section">
                        <form id="like-form" th:data-post-id="${post.id}">
                            <button type="button" id="like-button" class="like-btn">
                                <span class="like-heart">ğŸ‘</span>
                            </button>
                        </form>
                        <p class="like-count">
                            <span id="like-count" th:text="${post.likeCount}">0</span>
                        </p>
                    </div>

                    <!-- ìˆ˜ì • ë²„íŠ¼: ì‘ì„±ìë§Œ í‘œì‹œ -->
                    <a th:if="${#authentication.isAuthenticated() and #authentication.name == post.username}"
                       th:href="@{'/post/edit/' + ${post.id}}"
                       class="btn btn-primary me-2">ìˆ˜ì •</a>

                    <!-- ì‚­ì œ ë²„íŠ¼: ì‘ì„±ìë§Œ í‘œì‹œ -->
                    <form th:if="${#authentication.isAuthenticated() and #authentication.name == post.username}"
                          th:action="@{'/post/delete/' + ${post.id}}"
                          method="post"
                          style="display: inline;">
                        <button type="submit" class="btn btn-danger"
                                onclick="return confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                            ì‚­ì œ
                        </button>
                    </form>
                    <a th:href="@{/}" class="btn btn-secondary">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ëŒ“ê¸€ ì„¹ì…˜ -->
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="comment-section">
                <h4>ëŒ“ê¸€</h4>

                <!-- ìƒìœ„ ëŒ“ê¸€ ëª©ë¡ -->
                <div th:each="comment : ${comments}" class="comment mb-4">

                    <!-- ìƒìœ„ ëŒ“ê¸€ ë³¸ë¬¸ -->
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p>
                                <strong th:text="${comment.nickname}">ì‘ì„±ì</strong>
                                <span class="text-muted" th:text="${comment.createTime}">ì‘ì„±ì¼</span>
                            </p>

                            <!-- ì‚­ì œ ìƒíƒœì— ë”°ë¼ í‘œì‹œ êµ¬ë¶„ -->
                            <div th:if="${comment.deleted}">
                                <!-- ì‚­ì œëœ ê²½ìš° -->
                                <p class="text-muted">ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤</p>
                            </div>
                            <div th:if="${!comment.deleted}">
                                <!-- ì•„ì§ ì‚´ì•„ìˆëŠ” ëŒ“ê¸€ -->
                                <p th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</p>
                            </div>
                        </div>

                        <div class="comment-actions">
                            <!-- ìˆ˜ì • ë²„íŠ¼: ì‘ì„±ìë§Œ, ê·¸ë¦¬ê³  deleted=false ì¼ ë•Œë§Œ ë…¸ì¶œ (ìˆ˜ì • ë¶ˆê°€) -->
                            <button th:if="${(!comment.deleted) and (#authentication.isAuthenticated() and #authentication.name == comment.username)}"
                                    type="button"
                                    class="btn btn-sm btn-warning me-2"
                                    th:onclick="|toggleEditForm('editForm${comment.id}')|">
                                ìˆ˜ì •
                            </button>

                            <!-- ì‚­ì œ ë²„íŠ¼: ì‘ì„±ìë§Œ, deleted=false ì¼ ë•Œë§Œ -->
                            <form th:if="${(!comment.deleted) and (#authentication.isAuthenticated() and #authentication.name == comment.username)}"
                                  th:action="@{'/post/' + ${post.id} + '/comment/delete/' + ${comment.id}}"
                                  method="post"
                                  style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                    ì‚­ì œ
                                </button>
                            </form>

                            <!-- ëŒ€ëŒ“ê¸€ ë‹¬ê¸° ë²„íŠ¼: ë¡œê·¸ì¸ ì‚¬ìš©ìì—ê²Œë§Œ, deleted=false ì¼ ë•Œë§Œ -->
                            <button th:if="${(!comment.deleted) and (#authentication.isAuthenticated())}"
                                    type="button"
                                    class="btn btn-sm btn-primary ms-2"
                                    th:onclick="|toggleReplyForm('replyForm${comment.id}')|">
                                ë‹µê¸€
                            </button>
                        </div>
                    </div>

                    <!-- ìˆ˜ì • í¼ -->
                    <div th:id="|editForm${comment.id}|" class="edit-comment-form" style="display:none;"
                         th:if="${!comment.deleted}">
                        <form th:action="@{'/post/' + ${post.id} + '/comment/edit/' + ${comment.id}}" method="post">
                            <div class="mb-3">
                <textarea name="content" class="form-control" rows="3" required
                          th:text="${comment.content}"></textarea>
                            </div>
                            <button type="submit" class="btn btn-success btn-sm me-2">ì €ì¥</button>
                            <button type="button" class="btn btn-secondary btn-sm"
                                    th:onclick="|toggleEditForm('editForm${comment.id}')|">ì·¨ì†Œ
                            </button>
                        </form>
                    </div>

                    <!-- ëŒ€ëŒ“ê¸€ ì‘ì„± í¼ -->
                    <div th:id="|replyForm${comment.id}|" class="mt-2" style="display:none;"
                         th:if="${!comment.deleted}">
                        <form th:action="@{'/post/' + ${post.id} + '/comment/create'}" method="post">
                            <input type="hidden" name="parentId" th:value="${comment.id}"/>
                            <input type="hidden" name="postId" th:value="${post.id}"/>
                            <div class="mb-2">
                <textarea name="content" class="form-control" rows="2" placeholder="ëŒ€ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
                          required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm">ë“±ë¡</button>
                        </form>
                    </div>

                    <!-- ìì‹ ëŒ“ê¸€(ëŒ€ëŒ“ê¸€) ëª©ë¡: ì‚­ì œëœ ë¶€ëª¨ë¼ë„ ìì‹ì€ ê·¸ëŒ€ë¡œ í‘œì‹œ -->
                    <div th:if="${comment.children != null and !comment.children.isEmpty()}"
                         class="child-comments mt-3 ps-3 border-start border-2">
                        <div th:each="child : ${comment.children}" class="child-comment mb-3" style="margin-left:10px;">
                            <!-- ì•„ë˜ëŠ” ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ -->
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <p>
                                        <strong th:text="${child.nickname}">ëŒ€ëŒ“ê¸€ ì‘ì„±ì</strong>
                                        <span class="text-muted" th:text="${child.createTime}">ì‘ì„±ì¼</span>
                                    </p>
                                    <!-- child.deleted ì—¬ë¶€ì— ë”°ë¼ í‘œì‹œ êµ¬ë¶„ -->
                                    <div th:if="${child.deleted}">
                                        <p class="text-muted">ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤</p>
                                    </div>
                                    <div th:if="${!child.deleted}">
                                        <p th:text="${child.content}">ëŒ€ëŒ“ê¸€ ë‚´ìš©</p>
                                    </div>
                                </div>

                                <div class="comment-actions">
                                    <!-- ìˆ˜ì •, ì‚­ì œ ë²„íŠ¼ë„ child.deleted == falseì¼ ë•Œë§Œ í‘œì‹œ -->
                                    <button th:if="${(!child.deleted) and (#authentication.isAuthenticated() and #authentication.name == child.username)}"
                                            type="button"
                                            class="btn btn-sm btn-warning me-2"
                                            th:onclick="|toggleEditForm('editForm${child.id}')|">
                                        ìˆ˜ì •
                                    </button>

                                    <form th:if="${(!child.deleted) and (#authentication.isAuthenticated() and #authentication.name == child.username)}"
                                          th:action="@{'/post/' + ${post.id} + '/comment/delete/' + ${child.id}}"
                                          method="post"
                                          style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-danger"
                                                onclick="return confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                            ì‚­ì œ
                                        </button>
                                    </form>

                                    <!-- ëŒ€ëŒ“ê¸€ì—ë„ ë‹µê¸€ ë²„íŠ¼ ì¶”ê°€ -->
                                    <button th:if="${(!child.deleted) and (#authentication.isAuthenticated())}"
                                            type="button"
                                            class="btn btn-sm btn-primary ms-2"
                                            th:onclick="|toggleReplyForm('replyForm${child.id}')|">
                                        ë‹µê¸€
                                    </button>
                                </div>
                            </div>

                            <!-- ìì‹ ëŒ“ê¸€ ìˆ˜ì • í¼ -->
                            <div th:id="|editForm${child.id}|" class="edit-comment-form" style="display:none;"
                                 th:if="${!child.deleted}">
                                <form th:action="@{'/post/' + ${post.id} + '/comment/edit/' + ${child.id}}"
                                      method="post">
                                    <div class="mb-3">
                    <textarea name="content" class="form-control" rows="2" required
                              th:text="${child.content}"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success btn-sm me-2">ì €ì¥</button>
                                    <button type="button" class="btn btn-secondary btn-sm"
                                            th:onclick="|toggleEditForm('editForm${child.id}')|">ì·¨ì†Œ
                                    </button>
                                </form>
                            </div>

                            <!-- ìì‹ ëŒ“ê¸€ì— ëŒ€í•œ ë‹µê¸€ ì‘ì„± í¼ ì¶”ê°€ -->
                            <div th:id="|replyForm${child.id}|" class="mt-2 ms-3" style="display:none;"
                                 th:if="${!child.deleted}">
                                <form th:action="@{'/post/' + ${post.id} + '/comment/create'}" method="post">
                                    <input type="hidden" name="parentId" th:value="${child.id}"/>
                                    <input type="hidden" name="postId" th:value="${post.id}"/>
                                    <div class="mb-2">
                    <textarea name="content" class="form-control" rows="2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
                              required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-sm">ë“±ë¡</button>
                                </form>
                            </div>

                            <!-- ì†ì ëŒ“ê¸€ ëª©ë¡ (ëŒ€ëŒ“ê¸€ì˜ ëŒ€ëŒ“ê¸€) -->
                            <div th:if="${child.children != null and !child.children.isEmpty()}"
                                 class="child-comments mt-3 ps-3 border-start border-2">
                                <div th:each="grandChild : ${child.children}" class="child-comment mb-3"
                                     style="margin-left:10px;">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <p>
                                                <strong th:text="${grandChild.nickname}">ì†ìëŒ“ê¸€ ì‘ì„±ì</strong>
                                                <span class="text-muted" th:text="${grandChild.createTime}">ì‘ì„±ì¼</span>
                                            </p>
                                            <!-- ì†ì ëŒ“ê¸€ ì‚­ì œ ì—¬ë¶€ì— ë”°ë¥¸ í‘œì‹œ -->
                                            <div th:if="${grandChild.deleted}">
                                                <p class="text-muted">ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤</p>
                                            </div>
                                            <div th:if="${!grandChild.deleted}">
                                                <p th:text="${grandChild.content}">ì†ìëŒ“ê¸€ ë‚´ìš©</p>
                                            </div>
                                        </div>

                                        <div class="comment-actions">
                                            <!-- ìˆ˜ì •, ì‚­ì œ ë²„íŠ¼ -->
                                            <button th:if="${(!grandChild.deleted) and (#authentication.isAuthenticated() and #authentication.name == grandChild.username)}"
                                                    type="button" class="btn btn-sm btn-warning me-2"
                                                    th:onclick="|toggleEditForm('editForm${grandChild.id}')|">
                                                ìˆ˜ì •
                                            </button>

                                            <form th:if="${(!grandChild.deleted) and (#authentication.isAuthenticated() and #authentication.name == grandChild.username)}"
                                                  th:action="@{'/post/' + ${post.id} + '/comment/delete/' + ${grandChild.id}}"
                                                  method="post" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-danger"
                                                        onclick="return confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                                    ì‚­ì œ
                                                </button>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- ì†ì ëŒ“ê¸€ ìˆ˜ì • í¼ -->
                                    <div th:id="|editForm${grandChild.id}|" class="edit-comment-form"
                                         style="display:none;"
                                         th:if="${!grandChild.deleted}">
                                        <form th:action="@{'/post/' + ${post.id} + '/comment/edit/' + ${grandChild.id}}"
                                              method="post">
                                            <div class="mb-3">
                        <textarea name="content" class="form-control" rows="2" required
                                  th:text="${grandChild.content}"></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-success btn-sm me-2">ì €ì¥</button>
                                            <button type="button" class="btn btn-secondary btn-sm"
                                                    th:onclick="|toggleEditForm('editForm${grandChild.id}')|">ì·¨ì†Œ
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ìµœìƒìœ„ ëŒ“ê¸€ ì‘ì„± í¼ (ë°˜ë³µë¬¸ ë°–ìœ¼ë¡œ ì´ë™) -->
                <div th:if="${#authentication.isAuthenticated()}" class="mt-4">
                    <h5>ëŒ“ê¸€ ì‘ì„±</h5>
                    <form th:action="@{'/post/' + ${post.id} + '/comment/create'}" th:object="${commentForm}"
                          method="post">
                        <!-- ìµœìƒìœ„ ëŒ“ê¸€ì´ë¯€ë¡œ parentIdëŠ” ë„˜ê¸°ì§€ ì•ŠìŒ -->
                        <div class="mb-3">
              <textarea id="content" th:field="*{content}" class="form-control" rows="3"
                        placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
                            <div th:if="${#fields.hasErrors('content')}" class="text-danger"
                                 th:errors="*{content}"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">ì‘ì„±</button>
                    </form>
                </div>

                <div th:if="${!#authentication.isAuthenticated()}" class="mt-4">
                    <p>ëŒ“ê¸€ ì‘ì„±ì„ ì›í•˜ì‹œë©´ <a th:href="@{/login}">ë¡œê·¸ì¸</a>í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">ë¡œê·¸ì¸ í•„ìš”</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="ë‹«ê¸°">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ì·¨ì†Œ</button>
                <a th:href="@{/login}" class="btn btn-primary">ë¡œê·¸ì¸</a>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap JS ë° ì˜ì¡´ì„± -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function showLoginModal() {
        $('#loginModal').modal('show');
    }

    function toggleEditForm(formId) {
        var form = document.getElementById(formId);
        if (form.style.display === "none" || form.style.display === "") {
            form.style.display = "block";
        } else {
            form.style.display = "none";
        }
    }

    document.getElementById("like-button").addEventListener("click", function () {
        const postId = document.getElementById("like-form").getAttribute("data-post-id");

        fetch(`/api/likes/${postId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // ì„œë²„ì—ì„œ ìƒˆë¡œìš´ ì¢‹ì•„ìš” ê°œìˆ˜ë¥¼ ë°˜í™˜
                } else {
                    throw new Error("ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            })
            .then(data => {
                // ì¢‹ì•„ìš” ê°œìˆ˜ ì—…ë°ì´íŠ¸
                document.querySelector("#like-count").textContent = data.likeCount;
            })
            .catch(error => {
                console.error("Error:", error);
            });
    });


    function toggleEditForm(elementId) {
        const form = document.getElementById(elementId);
        if (form.style.display === 'none') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }

    function toggleReplyForm(elementId) {
        const form = document.getElementById(elementId);
        if (form.style.display === 'none') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }
</script>
</body>
</html>
